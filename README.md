> # Web Audio APIで、MML楽曲演奏
* サンプルページは、[ここ](https://gaku3iwa.github.io/node.mml/)
* MDX, FMP, PMD, ...など、昔のFM音源ドライバ関連資産を多く持ってる方々は、ScriptProcessorNodeでゴリゴリやってらっしゃるようですが…
* PSG音源（ファミコンの音）的な楽曲をOscillatorNode, GainNode, StereoPannerNodeでリアルタイムに再生することが目的
* 目的を果たすため、また楽曲データの制作手段として、下記のラッパーAPIを具現化しました
  | 処理     | 役割                                                     |
  | -------- | -------------------------------------------------------- |
  | parser   | MML（Music Macro Language）パーサーで、MMLコマンドの分解 |
  | assemble | 分解したMMLコマンドに基づき、Web Audio APIの組み立て     |
* MMLの詳細は…多くは語らん、[ここ](https://ja.wikipedia.org/wiki/Music_Macro_Language)を読め！

> ## 対応してるMMLコマンド

* MMLコマンドのアルファベット記述は、大文字でも小文字でもＯＫ！
  * 内部的には、小文字に変換して評価してます

> ## 制御コマンド
* コマンド表
  |  cmd  | 意味           |   値範囲    | 規定値 |
  | :---: | -------------- | :---------: | -----: |
  | T, t  | テンポ         |   1 ~ 480   |    120 |
  | V, v  | 音量           |   0 ~ 15    |     10 |
  |   !   | 一時的な音量   |   0 ~ 15    |     10 |
  | P, p  | パンポット     | -8 ~ 0 ~ +8 |      0 |
  | O, o  | オクターブ     |    1 ~ 9    |      4 |
  | L, l  | 音長           |   1 ~ 128   |      4 |
  | Q, q  | ゲートタイム   |    1 ~ 8    |      8 |
  |   >   | オクターブ上げ |
  |   <   | オクターブ下げ |
  |   &   | タイ or スラー |

* 制御コマンド（&）は、内部で「linearRampToValueAtTime」を利用して音を繋いでます
  * 指定のタイミングに向けて、音階（周波数）を直線的に変化させます
  * プログラム的には、タイかスラーか全く意識してません

* 制御コマンド（&）の後ろには、制御コマンド（V, !, P）も指定できます
  * こちらでも「linearRampToValueAtTime」を利用しています
  * 音量（V, !）を指定するとフェードイン、フェードアウト的な効果が期待できます
  * パンポット（P）なら、音の位置（左〜中央〜右）を滑らかに移動できます

> ## 音階コマンド
* コマンド表
  |  cmd  | 意味 |  cmd  | 意味     |
  | :---: | ---- | :---: | -------- |
  | C, c  | ド   | R, r  | 休符     |
  | D, d  | レ   | #, +  | 半音アゲ |
  | E, e  | ミ   |   -   | 半音サゲ |
  | F, f  | ファ |
  | G, g  | ソ   |
  | A, a  | ラ   |
  | B, b  | シ   |

> ## 音長指定
* コマンド表
  |  cmd  | 値範囲  | 意味                                                                      |
  | :---: | :-----: | ------------------------------------------------------------------------- |
  | 数値  | 1 ~ 128 | 音の長さを指定                                                            |
  |   .   |         | 付点（ピリオド）、指定した音長を1.5倍、ただし二重付点、三重付点には未対応 |

* 「テンポ=120」だった場合の音長と発音時間の関係
  | 音長 | 秒数 [sec] | 計算式                       |
  | ---: | ---------: | ---------------------------- |
  |    1 |        2.0 | = ( 60 / 120 ) x ( 4 /   1 ) |
  |    2 |        1.0 | = ( 60 / 120 ) x ( 4 /   2 ) |
  |    4 |        0.5 | = ( 60 / 120 ) x ( 4 /   4 ) |
  |    8 |       0.25 | = ( 60 / 120 ) x ( 4 /   8 ) |
  |   16 |      0.125 | = ( 60 / 120 ) x ( 4 /  16 ) |
  |   32 |     0.0625 | = ( 60 / 120 ) x ( 4 /  32 ) |
  |   64 |    0.03125 | = ( 60 / 120 ) x ( 4 /  64 ) |
  |  128 |   0.015625 | = ( 60 / 120 ) x ( 4 / 128 ) |

* ３連符の音長は、3, 6, 12,…など、３を乗算した値で…
  * 連符の音長の考え方は、１小節に連符の音符がいくつ入るのか考えよう
  * 意味がわからなければ、[ここ](https://ja.wikipedia.org/wiki/%E9%9F%B3%E7%AC%A6)を読め！

> ## 注意事項
* 音長指定の数値範囲を「1 ~ 128」とは記述してますが、パーサー処理内では上下限値を制限してません

* 使える音色（波形）は、今のところ矩形波（"square"）のみ
  * 制御コマンドで対応しても「OscillatorNode.type」指定程度かな？

* [LFO](https://ja.wikipedia.org/wiki/LFO_(%E9%9B%BB%E5%AD%90%E6%A5%BD%E5%99%A8))の制御コマンドは、未実装
  * パーサーが複雑になるから、実装してません😅
  * ビブラートやこぶしみたいな音の揺らぎ的な効果
  * これだけでも表現力が高まるのだが…orz

* [ADSR](https://ja.wikipedia.org/wiki/ADSR)の制御コマンドは、未実装
  * パーサーが複雑になるから、実装してません😅
  * エンベロープ・パラメータ（AR, DR, SR, RR）のこと
  * 代用として「v15 c1」とするところを
    * 「v15 c8 & !10 c8 & !8 c2 & !0 c4」
    * 制御コマンド（&）を拡張したので、こんな記述方法で徐々に音量が減衰できます

> ## MMLデータファイル構造
* JSON形式、複数の楽曲データを収められる形式にしてます
  * 「mml配列」として、複数の楽曲データを収められます
  * 「part配列」として、カンマ区切りで複数パートを記述できます

* 構造は、こんな感じ
  | 変数名   | １階層    | ２階層     |                   |
  | -------- | --------- | ---------- | ----------------- |
  | mml_data |
  |          | comment   |            | 任意の文字列      |
  |          | mml [ 0 ] |
  |          |           | title      | 曲のタイトル１    |
  |          |           | part [ 0 ] | 曲のパート１のMML |
  |          |           | part [ 1 ] | 曲のパート２のMML |
  |          | mml [ 1 ] |
  |          |           | title      | 曲のタイトル２    |
  |          |           | part [ 0 ] | 曲のパート１のMML |
  |          |           | part [ 1 ] | 曲のパート２のMML |
  |          |           | part [ 2 ] | 曲のパート３のMML |

* 具体的な「mml_data.js」の記述
  ```
  const mml_data = {
    comment: "コメント",
    mml: [
      {
        title: "曲のタイトル１",
        part: [
          "cdefgab>c",
          "cdefgab>c",
        ],
      },
      {
        title: "曲のタイトル２",
        part: [
          "cdefgab>c",
          "cdefgab>c",
          "cdefgab>c",
        ],
      },

      ……

    ],
  };
  ```

> ## HTMLの実装
* 実装例です
  * Web Audio APIの実装上、onloadイベントで自動的に演奏開始することはNGとされてるらしいです
  * 何らかのユーザーアクション（ボタンクリックなど）が必要になります
    * ```mml.play(0);```<br>
      「**mml_data.js**」内の楽曲（mml配列）をインデックス番号で指定するタイプ

    * ```mml.assemble(mml.parser(mml_data.mml[1].part));```<br>
      ```play```の中身、コレです😅

    * ```mml.assemble(mml.parser(['o4 cdefgab>c','o5 cdefgab>c']));```<br>
      MMLを直接記述するタイプ

* 実装例
  ```
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>SAMPLE</title>
    <link rel=”shortcut icon” href=”./favicon.ico” />
    <script src='./mml_data.js'></script>
    <script src='./mml_bundle.js'></script>
  </head>
  <body>
    <button onclick="mml.play(0);">play</button>
    <button onclick="mml.assemble(mml.parser(mml_data.mml[1].part));">play</button>
    <button onclick="mml.assemble(mml.parser(['o4 cdefgab>c','o5 cdefgab>c']));">play</button>
  </body>
  </html>
  ```

* サンプルの「**docs/index.html**」では「**mml_data.js**」内の楽曲（mml配列）を参照してます
  * 含まれる楽曲数分の再生ボタン、停止ボタンを動的に生成してます

  * 再生ボタンがクリックされる都度、MMLを分解して、Web Audio APIを組み立てる…そんな仕組みです

  * 工夫次第で、楽曲再生までのタイムラグは軽減できるけど…
    * 現時点では、ゲームのBGMや効果音などの利用用途など全く念頭にありません
    * 即時応答する必要性を感じてません😅

  * ver.1.0.3、MML編集領域（テキストエリア）を追加
    * 「**mml_data.js**」内の楽曲を再生したときにMMLを表示します
    * 編集領域下部の再生ボタン、停止ボタンで編集領域内のMMLを演奏・停止します

> ## 更新履歴
* バージョン履歴
  | version |     更新日 | メモ                                               |
  | ------: | ---------: | -------------------------------------------------- |
  |   1.0.4 | 2022.01.05 | ライブラリとしてwebpackでモジュールバンドル化      |
  |         |            | * ライブラリ名は「mml」                            |
  |         |            | * 公開メソッドは「play, parser, assemble」の３つ   |
  |   1.0.3 | 2022.01.04 | サンプルHTML改修                                   |
  |         |            | * 編集領域を設けて楽曲再生可能に変更               |
  |   1.0.2 | 2021.12.23 | 制御コマンド（V, !, P, L, Q）の上限値変更          |
  |         |            | * できる限り、他形式のMMLと揃えた                  |
  |   1.0.1 | 2021.12.18 | 制御コマンド（&）で、スラーにも対応                |
  |         |            | * 同じ音階で繋いだらタイ、違う音階で繋いだらスラー |
  |   1.0.0 | 2021.12.13 | 楽曲が演奏できる初期バージョンとしてリリース       |
  |         |            | * 発音時の音量を発音後、半分まで減衰する処理を追加 |
  |         |            | * "&"（タイ）の処理改善                            |
  |   0.0.1 | 2021.12.12 | "&"（タイ）の処理に不満あるけど、仮リリース        |

* 開発メモ
  * とりあえず、ピュアなJavaScript、Web Audio APIのみで、できるところまで頑張ってみた👍って感じ

  * ~~「**mml_parser.js**」へMML楽曲再生に必要な処理を全部詰め込むことはできたけど、**Prettier**で勝手に整形されたくない部分を「**mml_define.js**」にまとめただけです~~

  * MMLパーサーでは、MML文法のエラーハンドリングしてません
    * 個人的な試作品なので、取り扱いに注意してね♡

  * 将来的には…FM音源的な音色対応するとか、音声合成的なこと…まで出来ればイイけど
    * このソースで無理・無茶する気はありません

  * ver.1.0.4、ライブラリとして**webpack**でモジュールバンドルを図ってみた
    * モジュールバンドラーの使い方の勉強を兼ねて…😅

* 開発環境
  * 開発／テスト／楽曲再生、iMac(Late 2015) + VS Code + Chrome
  * 楽曲再生、iPad mini 5th + Chrome
