> # Web Audio APIで、MML楽曲演奏
* Vanilla JS（素のJavaScript）、
Web Audio API（OscillatorNode, GainNode, StereoPannerNode, …）を使って、
リアルタイムにPSG音源（ファミコンの音）的な楽曲演奏することが目的

* 8ビットコンピュータ、16ビットコンピュータが全盛時代、
MDX、FMP、PMD、…などのFM音源ドライバ関連資産を多く持ってる方々は、
_`ScriptProcessorNode`_ でゴリゴリやってらっしゃるソースを散見しましたが…

* 目的を果たすため、また楽曲データの制作手段として、下記のラッパーAPIを具現化
  | 処理     | 役割                                                     |
  | -------- | -------------------------------------------------------- |
  | parser   | MML（Music Macro Language）パーサーで、MMLコマンドの分解 |
  | assemble | 分解したMMLコマンドに基づき、Web Audio APIの組み立て     |

* MMLの詳細は…多くは語らん、[ここ](https://ja.wikipedia.org/wiki/Music_Macro_Language)を読んで！

* サンプルページは、[ここ](https://gaku3iwa.github.io/node.mml/)

> ## 対応してるMMLコマンド

* MMLコマンドのアルファベット記述は、大文字でも小文字でもＯＫ！

>> ### 制御コマンド
* コマンド表
  | cmd  | 意味           |   値範囲    | 規定値 |
  | ---- | -------------- | :---------: | -----: |
  | T, t | テンポ         |   1 ~ 480   |    120 |
  | V, v | 音量           |   0 ~ 15    |     10 |
  | !    | 一時的な音量   |   0 ~ 15    |     10 |
  | P, p | パンポット     | -8 ~ 0 ~ +8 |      0 |
  | O, o | オクターブ     |    1 ~ 9    |      4 |
  | L, l | 音長           |   1 ~ 128   |      4 |
  | Q, q | ゲートタイム   |    1 ~ 8    |      8 |
  | >    | オクターブ上げ |
  | <    | オクターブ下げ |
  | &    | タイ or スラー |
  | M, m | LFO            |

* 制御コマンド（&）は、内部で「_[exponentialRampToValueAtTime](https://webaudio.github.io/web-audio-api/#dom-audioparam-exponentialramptovalueattime)_」を利用して音を繋いでます（ver.1.1.0 ～）

  * 指定のタイミングに向けて、音階（周波数）を指数関数的に変化させます

  * プログラム的には、タイかスラーか全く意識してません

* 制御コマンド（&）の後ろには、制御コマンド（V, !, P）も指定できます

  * こちらでは「_[linearRampToValueAtTime](https://webaudio.github.io/web-audio-api/#dom-audioparam-linearramptovalueattime)_」を利用しています

  * 音量（V, !）を指定するとフェードイン、フェードアウト的な効果が期待できます

  * パンポット（P）なら、音の位置（左〜中央〜右）を滑らかに移動できます

>> ### 音階コマンド
* コマンド表
  | cmd  | 意味 | cmd  | 意味     |
  | ---- | ---- | ---- | -------- |
  | C, c | ド   | R, r | 休符     |
  | D, d | レ   | #, + | 半音アゲ |
  | E, e | ミ   | -    | 半音サゲ |
  | F, f | ファ |
  | G, g | ソ   |
  | A, a | ラ   |
  | B, b | シ   |

>> ### 音長指定
* コマンド表
  |  cmd  | 値範囲  | 意味                                                                      |
  | :---: | :-----: | ------------------------------------------------------------------------- |
  | 数値  | 1 ~ 128 | 音の長さを指定                                                            |
  |   .   |         | 付点（ピリオド）、指定した音長を1.5倍、ただし二重付点、三重付点には未対応 |

* 音長指定の数値範囲を「1 ~ 128」とは記述してますが、パーサー処理内では上下限値を制限してません
* 「テンポ=120」だった場合の音長と発音時間の関係
  | 音長 | 秒数 [sec] | 計算式                       |
  | ---: | ---------: | ---------------------------- |
  |    1 |        2.0 | = ( 60 / 120 ) x ( 4 /   1 ) |
  |    2 |        1.0 | = ( 60 / 120 ) x ( 4 /   2 ) |
  |    4 |        0.5 | = ( 60 / 120 ) x ( 4 /   4 ) |
  |    8 |       0.25 | = ( 60 / 120 ) x ( 4 /   8 ) |
  |   16 |      0.125 | = ( 60 / 120 ) x ( 4 /  16 ) |
  |   32 |     0.0625 | = ( 60 / 120 ) x ( 4 /  32 ) |
  |   64 |    0.03125 | = ( 60 / 120 ) x ( 4 /  64 ) |
  |  128 |   0.015625 | = ( 60 / 120 ) x ( 4 / 128 ) |

* ３連符の音長は、3, 6, 12,…など、３を乗算した値で…
  * 連符の音長の考え方は、１小節に音符がいくつ入るのか考えよう
  * 意味がわからなければ、[ここ](https://ja.wikipedia.org/wiki/%E9%9F%B3%E7%AC%A6)を読め！

>> ### LFOコマンド その１（ver.1.1.0にて実装）

>>> ### M1 */ &lt;speed&gt; / &lt;depth&gt; [ / &lt;gatetime&gt; ]*

>>> ### M2 */ &lt;speed&gt; / &lt;depth&gt; [ / &lt;gatetime&gt; ]*

* パラメータ表
  | cmd      | 意味               |                          |
  | -------- | ------------------ | ------------------------ |
  | type     | 揺らぎ効果のタイプ | 1:ビブラート、2:トレモロ |
  | speed    | 揺らぎ効果の回数   | 省略不可                 |
  | depth    | 揺らぎ効果の深さ   | 省略不可                 |
  | gatetime | 揺らぎ効果の音長   | 省略可                   |

* ### type | 揺らぎ効果のタイプ
  * LFOコマンドとして、ビブラート効果とトレモロ効果を実装
    | type | 意味           |                            |
    | ---: | -------------- | -------------------------- |
    |    1 | ビブラート効果 | 音程（周波数）の揺らぎ     |
    |    2 | トレモロ効果   | 音量（ボリューム）の揺らぎ |

* ### speed | 揺らぎ効果の回数
  * 揺らぎ効果の音長（getetime）の間、音の揺らす回数を指定
  * 内部的には、テンポと揺らぎ効果の音長から回数に応じた適切な周波数を求めてます

* ### depth | 揺らぎ効果の深さ
  * 小数値の指定も可能
  * 音の揺らす深さを指定
    | type          | 意味     |
    | ------------- | -------- |
    | 1: ビブラート | ± 周波数 |
    | 2: トレモロ   | ± 音量   |

* ### gatetime | 揺らぎ効果の音長
  * 省略した場合、次の音階コマンドで指定した音長

* ### 使用例
  | ex.) cmd   | 意味     |          |             |              |
  | ---------- | -------- | -------- | ----------- | ------------ |
  | M1/8/10 c2 | ドの音程 | ２分音符 | ド　 ± 10Hz | ８回の揺らぎ |
  | M2/4/50 c2 | ドの音程 | ２分音符 | 音量 ± 50%  | ４回の揺らぎ |

>> ### LFOコマンド その２（ver.1.2.0にて実装）

>>> ### M3 */ &lt;v speed&gt; / &lt;v depth&gt; / [ &lt;v gatetime&gt; ] / &lt;t speed&gt; / &lt;t depth&gt; [ / &lt;t gatetime&gt; ]*

* ビブラート効果とトレモロ効果を同時に適用
  * ビブラート効果とトレモロ効果のパラメータを繋げて記述する感じで…

* パラメータ表
  | cmd        |            | 意味               |                        |
  | ---------- | ---------- | ------------------ | ---------------------- |
  | type       |            | 揺らぎ効果のタイプ | 3:ビブラート＆トレモロ |
  | v speed    | ビブラート | 揺らぎ効果の回数   | 省略不可               |
  | v depth    | ビブラート | 揺らぎ効果の深さ   | 省略不可               |
  | v gatetime | ビブラート | 揺らぎ効果の音長   | 省略可                 |
  | t speed    | トレモロ   | 揺らぎ効果の回数   | 省略不可               |
  | t depth    | トレモロ   | 揺らぎ効果の深さ   | 省略不可               |
  | t gatetime | トレモロ   | 揺らぎ効果の音長   | 省略可                 |

* 使用例
  | ex.) cmd         | 意味     |          |                           |                              |
  | ---------------- | -------- | -------- | ------------------------- | ---------------------------- |
  | M3/8/10//4/50 c2 | ドの音程 | ２分音符 | ド　 ± 10Hz<br>音量 ± 50% | ８回の揺らぎ<br>４回の揺らぎ |

* 音の揺らぎの変化には、サイン波（"*sine*"）を使用

> ## 注意事項

* 使える音色（波形）は、矩形波（"*square*"）限定

* LFOは、ver.1.1.0にて実装済み
* ~~[LFO](https://ja.wikipedia.org/wiki/LFO_(%E9%9B%BB%E5%AD%90%E6%A5%BD%E5%99%A8))の制御コマンドは、未実装~~
  * ~~ビブラートやこぶしみたいな音の揺らぎ的な効果~~
  * ~~これだけでも表現力が高まる👍~~
  * ~~パーサーが複雑になるから、実装してません…orz~~
    * ~~でも代用として何か必要かも…考えてみるよ~~

* [ADSR](https://ja.wikipedia.org/wiki/ADSR)の制御コマンドは、未実装
  * エンベロープ・パラメータ（AR, DR, SR, RR）のこと
  * パーサーが複雑になるから、実装してません…orz
  * 代用として「v15 c1」とするところを
    * 「v15 c8 & !10 c8 & !8 c2 & !0 c4」
    * 制御コマンド（&）を拡張したので、こんな記述方法で徐々に音量が減衰できます

> ## MMLデータファイル構造
* JSON形式、複数の楽曲データを収められる形式にしてます
  * 「mml配列」として、複数の楽曲データを収められます
  * 「part配列」として、カンマ区切りで複数パートを記述できます

* 構造は、こんな感じ
  | 変数名   | １階層    | ２階層     |                    |
  | -------- | --------- | ---------- | ------------------ |
  | mml_data |
  |          | comment   |            | 任意の文字列       |
  |          | index     |            | 楽曲ソート順の配列 |
  |          | mml [ 0 ] |
  |          |           | title      | 曲のタイトル１     |
  |          |           | part [ 0 ] | 曲のパート１のMML  |
  |          |           | part [ 1 ] | 曲のパート２のMML  |
  |          | mml [ 1 ] |
  |          |           | title      | 曲のタイトル２     |
  |          |           | part [ 0 ] | 曲のパート１のMML  |
  |          |           | part [ 1 ] | 曲のパート２のMML  |
  |          |           | part [ 2 ] | 曲のパート３のMML  |

* 具体的な「mml_data.js」の記述
  ```
  const mml_data = {
    comment: "コメント",
    index: [1, 0],
    mml: [
      {
        title: "曲のタイトル１",
        part: [
          "cdefgab>c",
          "cdefgab>c",
        ],
      },
      {
        title: "曲のタイトル２",
        part: [
          "cdefgab>c",
          "cdefgab>c",
          "cdefgab>c",
        ],
      },

      ……

    ],
  };
  ```

> ## HTMLの実装
* 実装例です
  * Web Audio APIの実装上、onloadイベントで自動的に演奏開始することはNGとされてるらしいです
  * 何らかのユーザーアクション（ボタンクリックなど）が必要になります
    * `mml.play(0);`<br>
      「_**mml_data.js**_」内の楽曲（mml配列）をインデックス番号で指定するタイプ

    * `mml.assemble(mml.parser(mml_data.mml[1].part));`<br>
      ```play```の中身、コレです😅

    * `mml.assemble(mml.parser(['o4 cdefgab>c','o5 cdefgab>c']));`<br>
      MMLを直接記述するタイプ

* 実装例１
  ```
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>SAMPLE 1</title>
    <script src='./js/mml_bundle.js'></script>
    <script src='./js/mml_data.js'></script>
  </head>
  <body>
    <button onclick="mml.play(0);">play</button>
    <button onclick="mml.assemble(mml.parser(mml_data.mml[1].part));">play</button>
  </body>
  </html>
  ```

* 実装例２
  ```
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>SAMPLE 2</title>
    <script src='./js/mml_bundle.js'></script>
  </head>
  <body>
    <button onclick="mml.assemble(mml.parser(['o4 cdefgab>c','o5 cdefgab>c']));">play</button>
  </body>
  </html>
  ```

* サンプルの「_**docs/index.html**_」では「_**mml_data.js**_」内の楽曲（mml配列）を参照してます
  * 含まれる楽曲数分の再生ボタン、停止ボタンを動的に生成してます

  * 再生ボタンがクリックされる都度、MMLを分解、Web Audio APIで楽曲の組み立て…そんな仕組みです

  * 工夫次第で、楽曲再生までのタイムラグは多少軽減できるけど…
    * 即時応答する必要性を感じてません😅
    * ゲームBGMや効果音などの利用用途？…全く念頭にありません

  * ver.1.0.3、MML編集領域（テキストエリア）を追加
    * 「_**mml_data.js**_」内の楽曲を再生したときにMMLを表示します
    * 編集領域下部の再生ボタン、停止ボタンで編集領域内のMMLを演奏・停止します

> ## 更新履歴
* バージョン履歴
  | version |     更新日 | メモ                                               |
  | ------: | ---------: | -------------------------------------------------- |
  |   1.2.0 | 2022.10.21 | 制御コマンド（M）で、LFOに対応                     |
  |         |            | * ビブラート＆トレモロ効果(M3)を実装               |
  |         |            |                                                    |
  |   1.1.0 | 2022.10.13 | 制御コマンド（M）で、LFOに対応                     |
  |         |            | * ビブラート効果(M1)、トレモロ効果(M2)を実装       |
  |         |            |                                                    |
  |   1.0.4 | 2022.01.05 | ライブラリとしてwebpackでモジュールバンドル化      |
  |         |            | * ライブラリ名は「mml」                            |
  |         |            | * 公開メソッドは「play, parser, assemble」の３つ   |
  |   1.0.3 | 2022.01.04 | サンプルHTML改修                                   |
  |         |            | * 編集領域を設けて楽曲再生可能に変更               |
  |   1.0.2 | 2021.12.23 | 制御コマンド（V, !, P, L, Q）の上限値変更          |
  |         |            | * できる限り、他形式のMMLと揃えた                  |
  |   1.0.1 | 2021.12.18 | 制御コマンド（&）で、スラーにも対応                |
  |         |            | * 同じ音階で繋いだらタイ、違う音階で繋いだらスラー |
  |   1.0.0 | 2021.12.13 | 楽曲が演奏できる初期バージョンとしてリリース       |
  |         |            | * 発音時の音量を発音後、半分まで減衰する処理を追加 |
  |         |            | * "&"（タイ）の処理改善                            |
  |   0.0.1 | 2021.12.12 | "&"（タイ）の処理に不満あるけど、仮リリース        |

> ## 開発メモ
  * とりあえず、Vanilla JS、Web Audio APIで、できるところまで頑張ってみた👍って感じ

  * MMLパーサーでは、MML文法のエラーハンドリングしてません
    * 個人的な試作品なので、取り扱いに注意してね♡

  * ~~「_**mml_parser.js**_」へMML楽曲再生に必要な処理を全部詰め込むことはできたけど、**Prettier**で勝手に整形されたくない部分を「**mml_define.js**」にまとめただけです~~
  * ver.1.0.4にて、_**webpack**_ でモジュールバンドル化を図ってみた
    * モジュールバンドラーの使い方の勉強を兼ねて…😅
    * これで１つにパッケージ化した「_mml_bundle.js_」だけでMML再生できるよ😭

  * 将来的には
    * FM音源的な音色対応するとか
    * 音声合成的なこととか
    * まで出来ればイイけど
    * このソースで無理・無茶する気はありません

> ## 開発環境
  * 開発／テスト／楽曲再生、iMac(Late 2015), WindowsPC(Win10) + VS Code + Chrome
  * 楽曲再生、iPad mini 5th + Chrome
